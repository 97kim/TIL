ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ Docker ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•´ì„œ AWS ECRì— ì˜¬ë¦¬ê³  ì˜¬ë¼ê°„ ECRì˜ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AWS EBì— ë°°í¬í•´ë³´ì!

GitHub Actionsë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” í”„ë¡œì íŠ¸ì˜ ìµœìƒë‹¨ ê²½ë¡œì— <code>.github</code>ë¼ëŠ” ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“¤ê³  ê·¸ ì•„ë˜ì— <code>workflows</code> ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“ ë‹¤. ì´ì œ ê·¸ ì•ˆì— <code>yml</code> íŒŒì¼ì„ ìƒì„±í•œë‹¤.

> **ì˜ˆì‹œ**
<code>.github/workflows/example.yml</code>

ì¼ë‹¨ <code>yml</code> íŒŒì¼ì˜ ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.

```
name: Build and Push Docker Image
on:
  push:
    branches:
      - deploy
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
          IMAGE_TAG: ECRì— ì˜¬ë¼ê°ˆ ì´ë¯¸ì§€ì˜ íƒœê·¸
        run: |
          docker buildx build --platform=linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
      - name: Get current time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: YYYYMMDD_HH-mm-ss
          utcOffset: "+09:00"

      - name: Generate deployment package
        run: |
          mkdir -p deploy
          cp Dockerrun.aws.json deploy/Dockerrun.aws.json
          cd deploy && zip -r deploy.zip .
          
      - name: Beanstalk Deploy
        uses: einaregilsson/beanstalk-deploy@v14
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: AWS EB ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
          environment_name: AWS EB í™˜ê²½ ì´ë¦„
          version_label: earth-docker-${{steps.current-time.outputs.formattedTime}}
          region: ap-northeast-2
          deployment_package: deploy/deploy.zip
          wait_for_environment_recovery: 200
```

<hr>

ğŸ“Œ 1
```
name: Build and Push Docker Image
on:
  push:
    branches:
      - deploy
```

Build and Push Docker Imageë¼ëŠ” ì´ë¦„ì„ ê°–ëŠ” WorkflowëŠ” deploy ë¸Œëœì¹˜ì— Push ë  ê²½ìš° ê²½ìš° ì‹¤í–‰ëœë‹¤.

ğŸ“Œ 2
```
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      ... 

```

<code>Workflow</code>ëŠ” ë‹¤ì–‘í•œ <code>job</code>ìœ¼ë¡œ êµ¬ì„±ëœë‹¤. ìµœì†Œ í•œ ê°œ ì´ìƒì˜ jobì„ ì •ì˜í•´ì•¼ í•œë‹¤.
<code>build-and-push-image</code>ë¼ëŠ” <code>job</code>ì„ ìƒì„±í•˜ê³ , ê·¸ ì•„ë˜ì— <code>steps</code>ê°€ ì¡´ì¬í•˜ëŠ” êµ¬ì¡°ë‹¤.
<code>runs-on</code>ì€ ì–´ë–¤ OSì—ì„œ ì‹¤í–‰ë ì§€ ì§€ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ, <code>ubuntu-latest</code>ìµœì‹  ë²„ì „ì˜ ìš°ë¶„íˆ¬ í™˜ê²½ìœ¼ë¡œ ì§€ì •í–ˆë‹¤.
<code>steps</code>ì˜ <code>uses</code>ëŠ” ì–´ë–¤ ì•¡ì…˜ì„ ì‚¬ìš©í• ì§€ ì§€ì •í•˜ëŠ” ê²ƒì´ë‹¤. ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì•¡ì…˜ì„ ì‚¬ìš©í•  ë•Œ ì§€ì •í•œë‹¤.

<code>actions/checkout@v2</code>ëŠ” Workflowì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ê³µì‹ GitHub ì‘ì—…ì´ë‹¤.

> <code>ì²´í¬ì•„ì›ƒ</code>: ì €ì¥ì†Œ(ë¦¬í¬ì§€í† ë¦¬)ì—ì„œ íŒŒì¼ì„ ë°›ì•„ì˜¤ëŠ” ê²ƒ
<code>ì²´í¬ì¸</code>: ì²´í¬ì•„ì›ƒìœ¼ë¡œ ë°›ì•„ì˜¨ íŒŒì¼ì„ ìˆ˜ì • í›„, ì €ì¥ì†Œ(ë¦¬í¬ì§€í† ë¦¬)ë¥¼ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ê°±ì‹ í•˜ëŠ” ê²ƒ

ğŸ“Œ 3
```
- name: Set up JDK 1.8
  uses: actions/setup-java@v1
  with:
    java-version: 1.8
```
ìë°” ë²„ì „ì„ ì„¤ì •í•œë‹¤. 1.8ì€ Java 8ì´ë¼ëŠ” ê²ƒì¸ë° Java 11ë¶€í„°ëŠ” 11ë¡œ ì“°ê³  ìˆë‹¤.
https://docs.gradle.org/current/javadoc/org/gradle/api/JavaVersion.html ì—ì„œ ë´ë„ Java 11ë¶€í„° 11ë¡œ ì“°ê³  ìˆê³ , Java 10ê¹Œì§€ëŠ” 1.xë¡œ ì“°ê³  ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

ğŸ“Œ 4
```
- name: Grant execute permission for gradlew
  run: chmod +x gradlew

  - name: Build with Gradle
  run: ./gradlew clean build -x test
```
<code>run</code>ì—ëŠ” ì»¤ë§¨ë“œë¥¼ ë„£ìœ¼ë©´ ëœë‹¤.
<code>graldew</code> ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤. <code>./gradlew clean build -x test</code>ëŠ” í…ŒìŠ¤íŠ¸ ì—†ì´ ë¹Œë“œí•œë‹¤ëŠ” ëœ»ì´ë‹¤.

ğŸ“Œ 5
```
- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v1
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    aws-region: ap-northeast-2
```
AWS ìê²©ì„ ì¦ëª…í•˜ëŠ” ê²ƒì´ë‹¤. AWS iam ì‚¬ìš©ìì˜ <code>access key</code>ì™€ <code>secret key</code>ë¥¼ ë„£ìœ¼ë©´ ë˜ëŠ”ë° ì´ ë¶€ë¶„ì€ ì™¸ë¶€ì— ë…¸ì¶œë˜ë©´ ì•„ì£¼ ìœ„í—˜í•˜ë¯€ë¡œ <code>GitHubì˜ Secrets</code>ë¥¼ ì´ìš©í•œë‹¤. <code>ë¦¬í¬ì§€í† ë¦¬ Settings -> Secrets</code>ë¡œ ê°€ë©´ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
![](https://images.velog.io/images/rudwnd33/post/1e711d45-57df-451b-b808-1d95c13d75a7/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-12-12%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%204.33.29.png)

ğŸ“Œ 6
```
- name: Login to Amazon ECR
  id: login-ecr
  uses: aws-actions/amazon-ecr-login@v1

- name: Build, tag, and push image to Amazon ECR
  id: build-image
  env:
    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
    ECR_REPOSITORY: ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
    IMAGE_TAG: ECRì— ì˜¬ë¼ê°ˆ ì´ë¯¸ì§€ì˜ íƒœê·¸
  run: |
    docker buildx build --platform=linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
    docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
```
ë¡œì»¬ Docker í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•˜ë‚˜ ì´ìƒì˜ Amazon ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë¡œê·¸ì¸í•œë‹¤.
ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ê³  ECR ë¦¬í¬ì§€í† ë¦¬ì— push í•œë‹¤.

AWS EBë¡œ ìƒì„±ë˜ëŠ” EC2ëŠ” <code>linux/amd64</code> í™˜ê²½ì´ë‹¤. ë‚´ PC í™˜ê²½ì€ <code>linux/arm64(Mac M1)</code>ì´ë¼ì„œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì— <code>docker buildx build --platform=linux/amd64 -t</code>ë¥¼ ì‚¬ìš©í–ˆë‹¤. M1ì´ ì•„ë‹ˆë¼ë©´ <code>docker build -t</code>ë¥¼ ì‚¬ìš©í•´ë„ ë¬´ë°©í•˜ë‹¤.

```
FROM openjdk:8-jdk-alpine
COPY build/libs/*.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```
ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë¹Œë“œ ì‹œì— í•„ìš”í•œ <code>Dockerfile</code> íŒŒì¼ì´ë‹¤.
<code>alpine</code>ì„ ë¶™ì´ë©´ ìƒì„±ëœ ë„ì»¤ ì´ë¯¸ì§€ì˜ ìš©ëŸ‰ì´ ë” ì‘ë‹¤.
gradleë¡œ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•´ì„œ ìƒì„±ëœ <code>jar</code> íŒŒì¼ì„ ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•  ë•Œ í•„ìš”í•œ íŒŒì¼ì´ë‹¤.

gradleë¡œ ë¹Œë“œí•˜ë©´ <code>jar</code> íŒŒì¼ì´ 2ê°œê°€ ìƒì„±ë˜ëŠ”ë° í•˜ë‚˜ëŠ” <code>plain.jar</code>ë‹¤. <code>plain.jar</code>ëŠ” ì˜ì¡´ì„± ê´€ë ¨ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šê³  ëª¨ë“ˆì˜ í´ë˜ìŠ¤ì™€ ë¦¬ì†ŒìŠ¤ë§Œ í¬í•¨í•˜ëŠ” íŒŒì¼ì´ë‹¤.
(ì°¸ê³ : https://stackoverflow.com/questions/67935064/difference-between-spring-boot-2-5-0-generated-jar-and-plain-jar)

<code>build.gradle</code>ì—
```
jar {
    enabled = false
}
```
ë¥¼ ì‘ì„±í•˜ë©´ <code>gradle build</code> ì‹œì— <code>plain.jar</code>ê°€ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤.

ğŸ“Œ 7
```
- name: Get current time
  uses: 1466587594/get-current-time@v2
  id: current-time
  with:
    format: YYYYMMDD_HH-mm-ss
    utcOffset: "+09:00"
```
ìš°ë¦¬ë‚˜ë¼ ì‹œê°„ì€ UTC ê¸°ì¤€ìœ¼ë¡œ 9ì‹œê°„ì´ ë¹ ë¥´ê¸° ë•Œë¬¸ì— 9ì‹œê°„ì„ ë”í•œë‹¤.

ğŸ“Œ 8
```
- name: Generate deployment package
  run: |
    mkdir -p deploy
    cp Dockerrun.aws.json deploy/Dockerrun.aws.json
    cd deploy && zip -r deploy.zip .
```
<code>Dockerrun.aws.json</code> íŒŒì¼ì„ zip íŒŒì¼ë¡œ ë§Œë“œëŠ” ê³¼ì •ì´ë‹¤.

```
{
  "AWSEBDockerrunVersion": "1",
  "Image": {
    "Name": "ì´ë¯¸ì§€ URI(AWS ECRì—ì„œ í™•ì¸ ê°€ëŠ¥)",
    "Update": "true"
  },
  "Ports": [
    {
      "ContainerPort": 8080
    }
  ]
}
```
<code>Dockerrun.aws.json</code> íŒŒì¼ì´ë‹¤. AWS ECRì— ì˜¬ë¼ê°„ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•˜ëŠ” ë° í•„ìš”í•œ ì„¤ì •ì„ í•˜ëŠ” íŒŒì¼ì´ë‹¤.

ğŸ“Œ 9
```
- name: Beanstalk Deploy
  uses: einaregilsson/beanstalk-deploy@v14
  with:
    aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    application_name: AWS EB ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
    environment_name: AWS EB í™˜ê²½ ì´ë¦„
    version_label: earth-docker-${{steps.current-time.outputs.formattedTime}}
    region: ap-northeast-2
    deployment_package: deploy/deploy.zip
    wait_for_environment_recovery: 200
```

ì•„ê¹Œ ìƒì„±í•œ zip íŒŒì¼ì„ AWS EBì— ì—…ë¡œë“œ ë° ë°°í¬í•˜ëŠ” ê³¼ì •ì´ë‹¤.

ë„ì»¤ í™˜ê²½ì˜ AWS EBë¥¼ ë§Œë“¤ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì—…ë¡œë“œ ë° ë°°í¬ë¥¼ í•˜ë ¤ë©´ ì•„ë˜ ì‚¬ì§„ì˜ <code>ì—…ë¡œë“œ ë° ë°°í¬</code>ë¥¼ í´ë¦­í•´ <code>Dockerrun.aws.json</code>ë¥¼ ì••ì¶•í•œ íŒŒì¼ì„ ì˜¬ë¦¬ë©´ ëœë‹¤.

+ <code>Dockerrun.aws.json</code>ë§Œ ì˜¬ë¦¬ëŠ” ê²½ìš°ì—ëŠ” <code>zip</code>ìœ¼ë¡œ ì••ì¶•í•˜ì§€ ì•Šê³  ì˜¬ë ¤ë„ ëœë‹¤ê³  í•˜ëŠ”ë° ì•„ì§ ì§ì ‘ í•´ë³´ì§€ ì•Šì•„ í™•ì‹¤í•˜ì§„ ì•Šë‹¤.

![](https://images.velog.io/images/rudwnd33/post/8c401b49-0e7c-487f-ad0e-bac6acf9651d/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-12-12%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%205.00.03.png)

ìœ„ ì‚¬ì§„ì²˜ëŸ¼ AWS EB consoleì— ë“¤ì–´ê°€ ìˆ˜ë™ì ìœ¼ë¡œ ì—…ë¡œë“œ ë° ë°°í¬ë¥¼ í•  ìˆ˜ ìˆì§€ë§Œ <code>GitHub Actions</code>ë¥¼ í™œìš©í•œ <code>ë¬´ì¤‘ë‹¨ ë°°í¬</code>ë¥¼ êµ¬ì¶•í•  ê²ƒì´ê¸° ë•Œë¬¸ì— <code>.github/workflows/example.yml</code> ì— ìœ„ ë‚´ìš©ì„ ì‘ì„±í•œë‹¤.

ì´ì œ 99%ì˜ ì‘ì—…ì€ ëë‚¬ê³  AWS EBì˜ <code>êµ¬ì„± -> ë³´ì•ˆ</code>ìœ¼ë¡œ ê°€ì„œ

![](https://images.velog.io/imagesggg/rudwnd33/post/426059ec-04cd-41e9-bf03-4c46928eb329/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-12-12%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%205.22.05.png)

ì´ ì—­í• ì— ê¶Œí•œì„ í•˜ë‚˜ ì¶”ê°€í•´ì•¼ í•œë‹¤. <code>AWS IAM -> ì—­í• </code>ë¡œ ê°€ì„œ ìœ„ ì‚¬ì§„ì˜ ì—­í• ë¡œ ë“¤ì–´ê°„ë‹¤.

<code>AmazonEC2ContainerRegistryReadOnly</code>ë¥¼ ì¶”ê°€í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ì´ ë  ê²ƒì´ë‹¤.

ë! ğŸ‘